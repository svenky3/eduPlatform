<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Practice Test - Complete Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 32px;
        }

        .logo-text h1 {
            font-size: 28px;
            color: #333;
        }

        .logo-text p {
            color: #666;
            font-size: 14px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .welcome-text {
            text-align: right;
        }

        .welcome-text .name {
            font-weight: bold;
            color: #333;
        }

        .welcome-text .date {
            background: #fef3c7;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #92400e;
            margin-top: 5px;
            display: inline-block;
        }

        .btn-signout {
            padding: 10px 25px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-signout:hover {
            background: #4f46e5;
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Section Cards */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .section-card {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 20px;
            padding: 40px;
            color: white;
            text-align: center;
            transition: transform 0.3s;
        }

        .section-card:hover {
            transform: translateY(-5px);
        }

        .section-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .question-count {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mode-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .btn-quiz {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-quiz:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }

        .btn-primary {
            background: white;
            color: #6366f1;
            border: 2px solid white;
            font-weight: bold;
        }

        /* Quiz Screen */
        .quiz-screen {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .quiz-info {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .quiz-title {
            font-size: 24px;
            color: #333;
        }

        .mode-indicator {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .mode-practice {
            background: #d1fae5;
            color: #065f46;
        }

        .mode-test {
            background: #fee2e2;
            color: #991b1b;
        }

        .quiz-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            color: #dc2626;
            font-weight: bold;
        }

        .question-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .question-counter {
            font-size: 16px;
            color: #666;
        }

        .btn-nav {
            padding: 8px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-nav:hover:not(:disabled) {
            background: #4f46e5;
        }

        .btn-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 25px;
        }

        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            transition: width 0.3s;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        /* Question Container */
        .question-container {
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 25px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .answers {
            display: grid;
            gap: 15px;
        }

        .answer-option {
            padding: 18px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .answer-option:hover:not(.disabled) {
            border-color: #6366f1;
            background: #f0f9ff;
        }

        .answer-option.selected {
            border-color: #6366f1;
            background: #ede9fe;
        }

        .answer-option.correct {
            border-color: #10b981;
            background: #d1fae5;
        }

        .answer-option.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
        }

        .answer-option.disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .answer-letter {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            flex-shrink: 0;
        }

        .answer-option.selected .answer-letter {
            background: #6366f1;
            color: white;
        }

        .answer-option.correct .answer-letter {
            background: #10b981;
            color: white;
        }

        .answer-option.incorrect .answer-letter {
            background: #ef4444;
            color: white;
        }

        .answer-text {
            flex: 1;
            font-size: 16px;
        }

        .answer-feedback {
            margin-left: auto;
            font-size: 20px;
        }

        /* Explanation Box */
        .explanation-box {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 10px;
        }

        .explanation-box h4 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .explanation-box p {
            color: #78350f;
            line-height: 1.6;
        }

        /* Navigation Buttons */
        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .nav-button {
            padding: 12px 30px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .nav-button:hover:not(:disabled) {
            background: #4b5563;
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-next {
            background: #6366f1;
        }

        .btn-next:hover:not(:disabled) {
            background: #4f46e5;
        }

        .btn-submit {
            background: #10b981;
        }

        .btn-submit:hover {
            background: #059669;
        }

        /* Question Map */
        .btn-map {
            padding: 8px 20px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .question-map-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .question-map-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
        }

        .map-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .map-item:hover {
            border-color: #6366f1;
        }

        .map-item.answered {
            background: #ede9fe;
            border-color: #6366f1;
        }

        .map-item.current {
            background: #6366f1;
            color: white;
        }

        .map-item.correct {
            background: #d1fae5;
            border-color: #10b981;
        }

        .map-item.incorrect {
            background: #fee2e2;
            border-color: #ef4444;
        }

        /* Results Screen */
        .results-screen {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 60px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            text-align: center;
        }

        .results-icon {
            font-size: 80px;
            margin-bottom: 30px;
        }

        .results-title {
            font-size: 36px;
            color: #333;
            margin-bottom: 20px;
        }

        .score-display {
            font-size: 72px;
            font-weight: bold;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }

        .score-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 40px 0;
            padding: 30px;
            background: #f9fafb;
            border-radius: 15px;
        }

        .score-detail {
            text-align: center;
        }

        .detail-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .detail-label {
            color: #666;
            margin-top: 5px;
        }

        .results-actions {
            margin-top: 40px;
        }

        .btn-result {
            padding: 15px 40px;
            margin: 10px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .btn-result:hover {
            transform: translateY(-2px);
        }

        .btn-home {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .btn-review {
            background: #10b981;
            color: white;
        }

        .btn-retry {
            background: #f59e0b;
            color: white;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 60px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }

            .quiz-header {
                flex-direction: column;
                gap: 15px;
            }

            .quiz-info {
                flex-direction: column;
                gap: 10px;
            }

            .map-grid {
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">🎓</div>
                <div class="logo-text">
                    <h1>SAT Practice Test</h1>
                    <p>Master the SAT with Real Questions</p>
                </div>
            </div>
            <div class="user-section" id="userSection" style="display: none;">
                <div class="welcome-text">
                    <div class="name">Welcome: <span id="userName">Student</span></div>
                    <div class="date" id="currentDate">Mon, Aug 25 • 11:40 PM</div>
                </div>
                <button class="btn-signout" onclick="signOut()">Sign Out</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Loading State -->
        <div class="loading" id="loadingScreen">
            <div class="spinner"></div>
            <p>Loading questions...</p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboardScreen">
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="debugQuestions()" style="padding: 5px 10px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 5px; cursor: pointer; font-size: 12px;">
                    🔍 Debug: Check Questions
                </button>
            </div>
            <div class="sections-grid">
                <!-- Math Section -->
                <div class="section-card">
                    <div class="section-icon">🧮</div>
                    <h2 class="section-title">Math</h2>
                    <p class="question-count" id="mathCount">148 questions available</p>
                    <div class="mode-label">Choose Mode:</div>
                    <div class="mode-buttons">
                        <button class="btn-quiz" onclick="startQuiz('Math', 'practice')">Practice Mode</button>
                        <button class="btn-quiz btn-primary" onclick="startQuiz('Math', 'test')">Test Mode</button>
                    </div>
                    <p style="font-size: 12px; opacity: 0.8; margin-top: 15px;">
                        Practice: Instant feedback | Test: Feedback at end
                    </p>
                </div>

                <!-- Reading Section -->
                <div class="section-card">
                    <div class="section-icon">📚</div>
                    <h2 class="section-title">Reading</h2>
                    <p class="question-count" id="readingCount">40 questions available</p>
                    <div class="mode-label">Choose Mode:</div>
                    <div class="mode-buttons">
                        <button class="btn-quiz" onclick="startQuiz('Reading', 'practice')">Practice Mode</button>
                        <button class="btn-quiz btn-primary" onclick="startQuiz('Reading', 'test')">Test Mode</button>
                    </div>
                    <p style="font-size: 12px; opacity: 0.8; margin-top: 15px;">
                        Practice: Instant feedback | Test: Feedback at end
                    </p>
                </div>

                <!-- Writing Section -->
                <div class="section-card">
                    <div class="section-icon">✏️</div>
                    <h2 class="section-title">Writing</h2>
                    <p class="question-count" id="writingCount">42 questions available</p>
                    <div class="mode-label">Choose Mode:</div>
                    <div class="mode-buttons">
                        <button class="btn-quiz" onclick="startQuiz('Writing', 'practice')">Practice Mode</button>
                        <button class="btn-quiz btn-primary" onclick="startQuiz('Writing', 'test')">Test Mode</button>
                    </div>
                    <p style="font-size: 12px; opacity: 0.8; margin-top: 15px;">
                        Practice: Instant feedback | Test: Feedback at end
                    </p>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div class="quiz-screen" id="quizScreen">
            <div class="quiz-header">
                <div class="quiz-info">
                    <h2 class="quiz-title" id="quizTitle">Math Section</h2>
                    <span class="mode-indicator" id="modeIndicator">Practice Mode</span>
                </div>
                <div class="quiz-timer" id="timerSection">
                    <span>⏰</span>
                    <span id="timer">70:00</span>
                </div>
                <div class="question-nav">
                    <span class="question-counter" id="questionCounter">1 / 148</span>
                    <button class="btn-map" onclick="showQuestionMap()">📋 Question Map</button>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 1%"></div>
                </div>
                <div class="progress-text">
                    <span id="progressStart">Question 1</span>
                    <span id="progressEnd">of 148</span>
                </div>
            </div>

            <div class="question-container">
                <div class="question-text" id="questionText">
                    Loading question...
                </div>
                <div class="answers" id="answersContainer">
                    <!-- Answer options will be inserted here -->
                </div>
                <div class="explanation-box" id="explanationBox">
                    <h4>Explanation:</h4>
                    <p id="explanationText"></p>
                </div>
            </div>

            <div class="quiz-navigation">
                <button class="nav-button" id="btnPrevious" onclick="previousQuestion()">← Previous</button>
                <button class="nav-button btn-next" id="btnNext" onclick="nextQuestion()">Next →</button>
                <button class="nav-button btn-submit" id="btnSubmit" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="results-screen" id="resultsScreen">
            <div class="results-icon">🏆</div>
            <h1 class="results-title">Quiz Complete!</h1>
            <div class="score-display" id="scoreDisplay">85%</div>
            
            <div class="score-details">
                <div class="score-detail">
                    <div class="detail-value" id="correctCount">17</div>
                    <div class="detail-label">Correct</div>
                </div>
                <div class="score-detail">
                    <div class="detail-value" id="incorrectCount">3</div>
                    <div class="detail-label">Incorrect</div>
                </div>
                <div class="score-detail">
                    <div class="detail-value" id="unansweredCount">0</div>
                    <div class="detail-label">Unanswered</div>
                </div>
                <div class="score-detail">
                    <div class="detail-value" id="totalQuestions">20</div>
                    <div class="detail-label">Total</div>
                </div>
                <div class="score-detail">
                    <div class="detail-value" id="timeSpent">25:30</div>
                    <div class="detail-label">Time Spent</div>
                </div>
            </div>

            <div class="results-actions">
                <button class="btn-result btn-home" onclick="goHome()">Back to Dashboard</button>
                <button class="btn-result btn-review" onclick="reviewAnswers()">Review Answers</button>
                <button class="btn-result btn-retry" onclick="retryQuiz()">Try Again</button>
            </div>
        </div>

        <!-- Question Map Modal -->
        <div class="question-map-modal" id="questionMapModal">
            <div class="question-map-content">
                <div class="map-header">
                    <h3>Question Overview</h3>
                    <button class="btn-nav" onclick="closeQuestionMap()">✕ Close</button>
                </div>
                <div class="map-grid" id="mapGrid">
                    <!-- Question numbers will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAv4Z5vAl8knY9RNs_U5VFObU3WKJGuxqg",
            authDomain: "sat-education-platform.firebaseapp.com",
            projectId: "sat-education-platform",
            storageBucket: "sat-education-platform.appspot.com",
            messagingSenderId: "135365605707",
            appId: "1:135365605707:web:17e2a91f0db00c4f6259e5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let allQuestions = [];
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizTimer = null;
        let timeRemaining = 0;
        let quizStartTime = null;
        let currentSection = '';
        let currentMode = 'test'; // 'practice' or 'test'
        let questionResults = {}; // Store results for practice mode

        // Initialize
        window.onload = function() {
            console.log('Platform loading...');
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            // Check Firebase connection
            if (typeof firebase === 'undefined') {
                console.error('Firebase not loaded!');
                alert('Firebase failed to load. Please refresh the page.');
                return;
            }
            
            console.log('Firebase initialized:', firebaseConfig.projectId);
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('User authenticated:', user.uid);
                    currentUser = user;
                    showDashboard();
                } else {
                    console.log('No user, signing in anonymously...');
                    // For testing, auto-sign in anonymously
                    signInAnonymously();
                }
            });
        };

        // Update date/time
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            const date = now.toLocaleDateString('en-US', options);
            const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            document.getElementById('currentDate').textContent = `${date} • ${time}`;
        }

        // Sign in anonymously for testing
        async function signInAnonymously() {
            try {
                const result = await auth.signInAnonymously();
                currentUser = result.user;
                showDashboard();
            } catch (error) {
                console.error('Sign in error:', error);
                // Still show dashboard for testing
                currentUser = { uid: 'test', displayName: 'Test User' };
                showDashboard();
            }
        }

        // Sign out
        async function signOut() {
            try {
                await auth.signOut();
                location.reload();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Show dashboard
        async function showDashboard() {
            document.getElementById('loadingScreen').style.display = 'block';
            
            // Update user info
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName || 'Student';
                document.getElementById('userSection').style.display = 'flex';
            }

            // Load questions
            await loadQuestions();

            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'none';
        }

        // Load questions from Firebase
        async function loadQuestions() {
            try {
                console.log('Loading questions from Firebase...');
                const snapshot = await db.collection('satQuestions').get();
                allQuestions = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Ensure each question has required fields
                    if (data.question && data.type) {
                        allQuestions.push({
                            id: doc.id,
                            question: data.question,
                            answerA: data.answerA || data.A || '',
                            answerB: data.answerB || data.B || '',
                            answerC: data.answerC || data.C || '',
                            answerD: data.answerD || data.D || '',
                            correctAnswer: data.correctAnswer || data.correct || 'A',
                            type: data.type,
                            difficulty: data.difficulty || 'Medium',
                            explanation: data.explanation || `The correct answer is ${data.correctAnswer || 'A'}`
                        });
                    }
                });

                console.log(`Loaded ${allQuestions.length} questions from Firebase`);

                // Count questions by type
                const counts = {
                    Math: 0,
                    Reading: 0,
                    Writing: 0,
                    Unknown: 0
                };

                allQuestions.forEach(q => {
                    const type = q.type || 'Unknown';
                    if (type in counts) {
                        counts[type]++;
                    } else {
                        counts.Unknown++;
                    }
                });

                console.log('Question counts:', counts);

                // Update dashboard with actual counts or show warning
                if (counts.Math === 0 && counts.Reading === 0 && counts.Writing === 0) {
                    if (counts.Unknown > 0) {
                        alert(`Warning: ${counts.Unknown} questions found but they have no proper type assigned. Please fix question types in the database.`);
                    } else {
                        alert('No questions found in the database. Please check your Firebase connection and data.');
                    }
                }
                
                document.getElementById('mathCount').textContent = counts.Math > 0 ? 
                    `${counts.Math} questions available` : 'No questions available';
                document.getElementById('readingCount').textContent = counts.Reading > 0 ? 
                    `${counts.Reading} questions available` : 'No questions available';
                document.getElementById('writingCount').textContent = counts.Writing > 0 ? 
                    `${counts.Writing} questions available` : 'No questions available';

                // Check for missing correct answers
                let missingCorrectAnswers = 0;
                allQuestions.forEach(q => {
                    if (!q.correctAnswer || q.correctAnswer === '') {
                        missingCorrectAnswers++;
                        console.warn('Question missing correct answer:', q);
                    }
                });
                
                if (missingCorrectAnswers > 0) {
                    console.warn(`WARNING: ${missingCorrectAnswers} questions have no correct answer set!`);
                    alert(`Warning: ${missingCorrectAnswers} questions have no correct answer set. Scoring may not work properly.`);
                }

                // If no questions loaded from Firebase, show error
                if (allQuestions.length === 0) {
                    console.warn('No questions loaded from Firebase, using sample questions');
                    loadSampleQuestions();
                }

            } catch (error) {
                console.error('Error loading questions from Firebase:', error);
                alert('Failed to load questions from database. Using sample questions.');
                // Load sample questions for testing
                loadSampleQuestions();
            }
        }

        // Load sample questions for testing
        function loadSampleQuestions() {
            console.log('Loading sample questions for testing...');
            
            // Create proper sample questions with all required fields
            const mathQuestions = [];
            const answers = ['A', 'B', 'C', 'D'];
            
            for (let i = 0; i < 148; i++) {
                mathQuestions.push({
                    id: `math_${i}`,
                    type: 'Math',
                    question: `Math Question ${i + 1}: If 2x + ${i} = ${15 + i}, what is the value of x?`,
                    answerA: `${Math.floor(Math.random() * 10)}`,
                    answerB: `${Math.floor((15 + i - i) / 2)}`,  // Correct answer
                    answerC: `${Math.floor(Math.random() * 10 + 10)}`,
                    answerD: `${Math.floor(Math.random() * 10 + 15)}`,
                    correctAnswer: 'B',
                    explanation: `Solve for x: 2x + ${i} = ${15 + i}, so 2x = ${15}, therefore x = ${15/2}`
                });
            }

            const readingQuestions = [];
            for (let i = 0; i < 40; i++) {
                readingQuestions.push({
                    id: `reading_${i}`,
                    type: 'Reading',
                    question: `Reading Question ${i + 1}: Based on the passage, what is the author's main argument?`,
                    answerA: 'The author argues for environmental protection',
                    answerB: 'The author discusses economic policies',
                    answerC: 'The author examines social changes',
                    answerD: 'The author analyzes historical events',
                    correctAnswer: answers[Math.floor(Math.random() * 4)],
                    explanation: 'The main idea is clearly stated in the opening paragraph.'
                });
            }

            const writingQuestions = [];
            for (let i = 0; i < 42; i++) {
                writingQuestions.push({
                    id: `writing_${i}`,
                    type: 'Writing',
                    question: `Writing Question ${i + 1}: Which choice provides the most effective transition?`,
                    answerA: 'However, the results were unexpected.',
                    answerB: 'Furthermore, the data supported this.',
                    answerC: 'In conclusion, we can see that.',
                    answerD: 'Nevertheless, researchers continued.',
                    correctAnswer: answers[Math.floor(Math.random() * 4)],
                    explanation: 'This transition word best connects the ideas in the paragraph.'
                });
            }

            allQuestions = [...mathQuestions, ...readingQuestions, ...writingQuestions];
            console.log(`Loaded ${allQuestions.length} sample questions`);

            document.getElementById('mathCount').textContent = '148 questions available';
            document.getElementById('readingCount').textContent = '40 questions available';
            document.getElementById('writingCount').textContent = '42 questions available';
        }

        // Start quiz
        function startQuiz(section, mode) {
            currentSection = section;
            currentMode = mode;
            currentQuizQuestions = allQuestions.filter(q => q.type === section);
            
            console.log(`Starting ${section} quiz with ${currentQuizQuestions.length} questions`);
            
            if (currentQuizQuestions.length === 0) {
                alert(`No questions available for ${section} section. Please check if questions are loaded properly.`);
                return;
            }

            // Check if questions have proper structure
            const sampleQuestion = currentQuizQuestions[0];
            if (!sampleQuestion.question || (!sampleQuestion.answerA && !sampleQuestion.A)) {
                console.error('Questions may not be properly formatted:', sampleQuestion);
                alert('Warning: Questions may not be properly formatted. Please check the database.');
            }

            // Shuffle questions for variety
            currentQuizQuestions.sort(() => Math.random() - 0.5);

            // Reset quiz state
            currentQuestionIndex = 0;
            userAnswers = {};
            questionResults = {};
            quizStartTime = new Date();

            // Set timer based on section
            if (section === 'Math') {
                timeRemaining = 70 * 60; // 70 minutes
            } else if (section === 'Reading') {
                timeRemaining = 65 * 60; // 65 minutes
            } else {
                timeRemaining = 35 * 60; // 35 minutes for Writing
            }

            // Show quiz screen
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'block';
            document.getElementById('quizTitle').textContent = `${section} Section`;
            
            // Update mode indicator
            const modeIndicator = document.getElementById('modeIndicator');
            modeIndicator.textContent = mode === 'practice' ? 'Practice Mode' : 'Test Mode';
            modeIndicator.className = mode === 'practice' ? 'mode-indicator mode-practice' : 'mode-indicator mode-test';

            // Hide timer in practice mode
            if (mode === 'practice') {
                document.getElementById('timerSection').style.display = 'none';
            } else {
                document.getElementById('timerSection').style.display = 'flex';
                startTimer();
            }

            // Display first question
            displayQuestion();
        }

        // Start timer
        function startTimer() {
            if (quizTimer) clearInterval(quizTimer);

            quizTimer = setInterval(() => {
                timeRemaining--;
                
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeRemaining <= 0) {
                    clearInterval(quizTimer);
                    submitQuiz();
                }
            }, 1000);
        }

        // Display question
        function displayQuestion() {
            const question = currentQuizQuestions[currentQuestionIndex];
            
            if (!question) {
                console.error('No question found at index:', currentQuestionIndex);
                return;
            }

            console.log('Displaying question:', question);

            // Update progress
            document.getElementById('questionCounter').textContent = 
                `${currentQuestionIndex + 1} / ${currentQuizQuestions.length}`;
            document.getElementById('progressStart').textContent = `Question ${currentQuestionIndex + 1}`;
            document.getElementById('progressEnd').textContent = `of ${currentQuizQuestions.length}`;
            document.getElementById('progressFill').style.width = 
                `${((currentQuestionIndex + 1) / currentQuizQuestions.length) * 100}%`;

            // Display question text
            const questionText = question.question || 'Question text not available';
            document.getElementById('questionText').textContent = questionText;

            // Display answer options
            const answersContainer = document.getElementById('answersContainer');
            answersContainer.innerHTML = '';

            const options = ['A', 'B', 'C', 'D'];
            let hasAnswers = false;
            
            options.forEach(letter => {
                const answerText = question[`answer${letter}`] || question[letter];
                if (answerText && answerText.trim() !== '') {
                    hasAnswers = true;
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'answer-option';
                    optionDiv.dataset.letter = letter;
                    
                    // In practice mode, check if this question was already answered
                    if (currentMode === 'practice' && questionResults[currentQuestionIndex]) {
                        const result = questionResults[currentQuestionIndex];
                        optionDiv.classList.add('disabled');
                        
                        if (letter === result.selected) {
                            optionDiv.classList.add(result.correct ? 'correct' : 'incorrect');
                        }
                        if (letter === question.correctAnswer && !result.correct) {
                            optionDiv.classList.add('correct');
                        }
                    } else {
                        optionDiv.onclick = () => selectAnswer(letter, optionDiv);
                    }
                    
                    if (userAnswers[currentQuestionIndex] === letter) {
                        optionDiv.classList.add('selected');
                    }

                    let feedbackIcon = '';
                    if (currentMode === 'practice' && questionResults[currentQuestionIndex]) {
                        const result = questionResults[currentQuestionIndex];
                        if (letter === result.selected && result.correct) {
                            feedbackIcon = '<span class="answer-feedback">✓</span>';
                        } else if (letter === result.selected && !result.correct) {
                            feedbackIcon = '<span class="answer-feedback">✗</span>';
                        } else if (letter === question.correctAnswer && !result.correct) {
                            feedbackIcon = '<span class="answer-feedback">✓</span>';
                        }
                    }

                    optionDiv.innerHTML = `
                        <div class="answer-letter">${letter}</div>
                        <div class="answer-text">${answerText}</div>
                        ${feedbackIcon}
                    `;
                    
                    answersContainer.appendChild(optionDiv);
                }
            });

            // If no answers found, show error
            if (!hasAnswers) {
                answersContainer.innerHTML = '<p style="color: red;">No answer options available for this question.</p>';
                console.error('No answers found for question:', question);
            }

            // Show explanation in practice mode if answered
            if (currentMode === 'practice' && questionResults[currentQuestionIndex]) {
                showExplanation();
            } else {
                document.getElementById('explanationBox').style.display = 'none';
            }

            // Update navigation buttons
            document.getElementById('btnPrevious').disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === currentQuizQuestions.length - 1) {
                document.getElementById('btnNext').style.display = 'none';
                document.getElementById('btnSubmit').style.display = 'inline-block';
            } else {
                document.getElementById('btnNext').style.display = 'inline-block';
                document.getElementById('btnSubmit').style.display = 'none';
            }
        }

        // Select answer
        function selectAnswer(letter, optionElement) {
            const question = currentQuizQuestions[currentQuestionIndex];
            
            // Make sure we have a valid correct answer
            if (!question.correctAnswer) {
                console.error('No correct answer set for this question!');
                alert('Error: This question has no correct answer set. Please report this issue.');
                return;
            }
            
            userAnswers[currentQuestionIndex] = letter;
            
            if (currentMode === 'practice') {
                // Immediate feedback in practice mode
                const isCorrect = letter === question.correctAnswer;
                questionResults[currentQuestionIndex] = {
                    selected: letter,
                    correct: isCorrect
                };

                console.log(`Answer selected: ${letter}, Correct answer: ${question.correctAnswer}, Result: ${isCorrect ? 'CORRECT' : 'WRONG'}`);

                // Update UI
                document.querySelectorAll('.answer-option').forEach(option => {
                    option.classList.add('disabled');
                    option.onclick = null;
                    
                    if (option.dataset.letter === letter) {
                        option.classList.add(isCorrect ? 'correct' : 'incorrect');
                        option.innerHTML += `<span class="answer-feedback">${isCorrect ? '✓' : '✗'}</span>`;
                    }
                    if (option.dataset.letter === question.correctAnswer && !isCorrect) {
                        option.classList.add('correct');
                        option.innerHTML += '<span class="answer-feedback">✓</span>';
                    }
                });

                showExplanation();
            } else {
                // Test mode - just mark as selected
                document.querySelectorAll('.answer-option').forEach(option => {
                    option.classList.remove('selected');
                });
                optionElement.classList.add('selected');
                console.log(`Test mode - Answer selected: ${letter}`);
            }
        }

        // Show explanation
        function showExplanation() {
            const question = currentQuizQuestions[currentQuestionIndex];
            const explanationBox = document.getElementById('explanationBox');
            const explanationText = document.getElementById('explanationText');
            
            explanationText.textContent = question.explanation || 
                `The correct answer is ${question.correctAnswer}.`;
            explanationBox.style.display = 'block';
        }

        // Next question
        function nextQuestion() {
            if (currentQuestionIndex < currentQuizQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        // Previous question
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        // Show question map
        function showQuestionMap() {
            const mapGrid = document.getElementById('mapGrid');
            mapGrid.innerHTML = '';

            for (let i = 0; i < currentQuizQuestions.length; i++) {
                const mapItem = document.createElement('div');
                mapItem.className = 'map-item';
                mapItem.textContent = i + 1;
                
                if (userAnswers[i] !== undefined) {
                    mapItem.classList.add('answered');
                }
                
                if (currentMode === 'practice' && questionResults[i]) {
                    if (questionResults[i].correct) {
                        mapItem.classList.add('correct');
                    } else {
                        mapItem.classList.add('incorrect');
                    }
                }
                
                if (i === currentQuestionIndex) {
                    mapItem.classList.add('current');
                }
                
                mapItem.onclick = () => {
                    currentQuestionIndex = i;
                    displayQuestion();
                    closeQuestionMap();
                };
                
                mapGrid.appendChild(mapItem);
            }

            document.getElementById('questionMapModal').style.display = 'flex';
        }

        // Close question map
        function closeQuestionMap() {
            document.getElementById('questionMapModal').style.display = 'none';
        }

        // Submit quiz
        async function submitQuiz() {
            if (quizTimer) clearInterval(quizTimer);

            // Calculate score - only count answered questions
            let correct = 0;
            let answered = 0;
            let unanswered = 0;
            
            currentQuizQuestions.forEach((question, index) => {
                if (userAnswers[index] !== undefined) {
                    answered++;
                    if (userAnswers[index] === question.correctAnswer) {
                        correct++;
                    }
                } else {
                    unanswered++;
                }
            });

            // If no questions were answered, score is 0
            const score = answered > 0 ? Math.round((correct / currentQuizQuestions.length) * 100) : 0;
            const incorrect = answered - correct;
            
            const timeSpent = Math.floor((new Date() - quizStartTime) / 1000);
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;

            console.log(`Quiz Results: Answered ${answered}, Correct ${correct}, Unanswered ${unanswered}`);

            // Show warning if there are unanswered questions
            if (unanswered > 0 && currentMode === 'test') {
                if (!confirm(`You have ${unanswered} unanswered questions. Are you sure you want to submit?`)) {
                    return;
                }
            }

            // Display results
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            document.getElementById('scoreDisplay').textContent = `${score}%`;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('incorrectCount').textContent = incorrect;
            document.getElementById('unansweredCount').textContent = unanswered;
            document.getElementById('totalQuestions').textContent = currentQuizQuestions.length;
            document.getElementById('timeSpent').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Save results to Firebase
            if (currentUser && currentUser.uid !== 'test') {
                try {
                    await db.collection('quizResults').add({
                        userId: currentUser.uid,
                        userName: currentUser.displayName || 'Anonymous',
                        section: currentSection,
                        mode: currentMode,
                        score: score,
                        correct: correct,
                        incorrect: incorrect,
                        unanswered: unanswered,
                        total: currentQuizQuestions.length,
                        timeSpent: timeSpent,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving results:', error);
                }
            }
        }

        // Review answers (for test mode)
        function reviewAnswers() {
            currentQuestionIndex = 0;
            currentMode = 'review'; // Special mode to show all answers
            
            // Mark all questions as answered for review
            currentQuizQuestions.forEach((question, index) => {
                questionResults[index] = {
                    selected: userAnswers[index] || null,
                    correct: userAnswers[index] === question.correctAnswer
                };
            });

            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'block';
            document.getElementById('modeIndicator').textContent = 'Review Mode';
            document.getElementById('modeIndicator').className = 'mode-indicator mode-practice';
            document.getElementById('timerSection').style.display = 'none';
            
            displayQuestion();
        }

        // Go home
        function goHome() {
            location.reload();
        }

        // Retry quiz
        function retryQuiz() {
            startQuiz(currentSection, currentMode === 'review' ? 'test' : currentMode);
        }

        // Debug function to check loaded questions
        function debugQuestions() {
            console.log('=== DEBUG: Question Check ===');
            console.log(`Total questions loaded: ${allQuestions.length}`);
            
            const types = {};
            allQuestions.forEach(q => {
                types[q.type] = (types[q.type] || 0) + 1;
            });
            console.log('Questions by type:', types);
            
            if (allQuestions.length > 0) {
                console.log('Sample question structure:', allQuestions[0]);
                console.log('First 3 questions:', allQuestions.slice(0, 3));
            }
            
            // Create debug report
            let report = `Questions Debug Report:\n`;
            report += `Total: ${allQuestions.length}\n`;
            report += `Math: ${types.Math || 0}\n`;
            report += `Reading: ${types.Reading || 0}\n`;
            report += `Writing: ${types.Writing || 0}\n`;
            report += `Unknown: ${types.Unknown || 0}\n\n`;
            
            if (allQuestions.length > 0) {
                report += `Sample Question:\n`;
                const sample = allQuestions[0];
                report += `- Question: ${sample.question ? sample.question.substring(0, 50) + '...' : 'NO QUESTION TEXT'}\n`;
                report += `- Answer A: ${sample.answerA || sample.A || 'MISSING'}\n`;
                report += `- Answer B: ${sample.answerB || sample.B || 'MISSING'}\n`;
                report += `- Answer C: ${sample.answerC || sample.C || 'MISSING'}\n`;
                report += `- Answer D: ${sample.answerD || sample.D || 'MISSING'}\n`;
                report += `- Correct: ${sample.correctAnswer || 'NOT SET'}\n`;
            }
            
            alert(report);
        }

        // Close modal when clicking outside
        document.getElementById('questionMapModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQuestionMap();
            }
        });
    </script>
</body>
</html>